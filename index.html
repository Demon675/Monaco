<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monaco Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #2b2b2b;
            overflow: hidden;
        }

        .editor-wrapper {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Tab Bar */
        .tab-bar {
            background-color: #6e6e6e;
            display: flex;
            align-items: center;
            height: 26px;
            border-bottom: 1px solid #4a4a4a;
            overflow-x: auto;
            overflow-y: hidden;
        }

        .tab-bar::-webkit-scrollbar {
            height: 0;
        }

        .tab {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 0 8px;
            height: 100%;
            background-color: #6e6e6e;
            color: #f0f0f0;
            border-right: 1px solid #4a4a4a;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            font-size: 11px;
            transition: background-color 0.1s;
        }

        .tab:hover {
            background-color: #7e7e7e;
        }

        .tab.active {
            background-color: #2b2b2b;
            color: #ffffff;
        }

        .tab-name {
            pointer-events: none;
        }

        .tab-close {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 12px;
            height: 12px;
            border-radius: 2px;
            opacity: 0;
            transition: opacity 0.1s;
        }

        .tab:hover .tab-close,
        .tab.active .tab-close {
            opacity: 1;
        }

        .tab-close:hover {
            background-color: #8e8e8e;
        }

        .tab-close svg {
            width: 8px;
            height: 8px;
            fill: #f5f5f5;
        }

        .new-tab-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 26px;
            height: 100%;
            cursor: pointer;
            color: #f0f0f0;
            flex-shrink: 0;
        }

        .new-tab-btn:hover {
            background-color: #7e7e7e;
        }

        .new-tab-btn svg {
            width: 12px;
            height: 12px;
            fill: currentColor;
        }

        /* Editor Container */
        .editor-container {
            flex: 1;
            position: relative;
            background-color: #2b2b2b;
        }

        .editor-instance {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
        }

        .editor-instance.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="editor-wrapper">
        <div class="tab-bar" id="tabBar">
            <div class="new-tab-btn" id="newTabBtn" title="Neuer Tab">
                <svg viewBox="0 0 16 16">
                    <path d="M8 3.5a.5.5 0 0 1 .5.5v3.5H12a.5.5 0 0 1 0 1H8.5V12a.5.5 0 0 1-1 0V8.5H4a.5.5 0 0 1 0-1h3.5V4a.5.5 0 0 1 .5-.5z" />
                </svg>
            </div>
        </div>
        <div class="editor-container" id="editorContainer"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/loader.min.js"></script>
    <script>
        require.config({
            paths: {
                'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs'
            }
        });

        let tabIdCounter = 0;
        let activeTabId = null;
        const tabs = new Map();

        const tabBar = document.getElementById('tabBar');
        const newTabBtn = document.getElementById('newTabBtn');
        const editorContainer = document.getElementById('editorContainer');

        require(['vs/editor/editor.main'], function() {
            createNewTab();
        });

        function createNewTab() {
            tabIdCounter++;
            const tabId = tabIdCounter;
            const tabName = `New Tab ${tabId}`;

            const tabElement = document.createElement('div');
            tabElement.className = 'tab';
            tabElement.dataset.tabId = tabId;
            tabElement.innerHTML = `
                <span class="tab-name">${tabName}</span>
                <span class="tab-close">
                    <svg viewBox="0 0 16 16">
                        <path d="M8 8.707l3.646 3.647.708-.707L8.707 8l3.647-3.646-.707-.708L8 7.293 4.354 3.646l-.707.708L7.293 8l-3.646 3.646.707.708L8 8.707z"/>
                    </svg>
                </span>
            `;

            tabBar.insertBefore(tabElement, newTabBtn);

            const hostElement = document.createElement('div');
            hostElement.className = 'editor-instance';
            hostElement.dataset.tabId = tabId;
            editorContainer.appendChild(hostElement);

            const editor = monaco.editor.create(hostElement, {
                value: 'print("Welcome to Synapse X")',
                language: 'lua',
                theme: 'vs-dark',
                automaticLayout: true,
                fontSize: 14,
                minimap: { enabled: false },
                scrollBeyondLastLine: false,
                fontFamily: 'Consolas, "Courier New", monospace',
                suggestOnTriggerCharacters: true,
                quickSuggestions: true,
                tabSize: 4
            });

            tabs.set(tabId, {
                element: tabElement,
                editor: editor,
                hostElement: hostElement,
                name: tabName
            });

            tabElement.addEventListener('click', (e) => {
                if (!e.target.closest('.tab-close')) {
                    switchToTab(tabId);
                }
            });

            const closeBtn = tabElement.querySelector('.tab-close');
            closeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                closeTab(tabId);
            });

            switchToTab(tabId);
        }

        function switchToTab(tabId) {
            if (activeTabId === tabId) return;

            tabs.forEach((tab, id) => {
                tab.element.classList.remove('active');
                tab.hostElement.classList.remove('active');
            });

            const tab = tabs.get(tabId);
            if (tab) {
                tab.element.classList.add('active');
                tab.hostElement.classList.add('active');
                activeTabId = tabId;

                setTimeout(() => {
                    tab.editor.layout();
                    tab.editor.focus();
                }, 0);
            }
        }

        function closeTab(tabId) {
            const tab = tabs.get(tabId);
            if (!tab) return;

            if (tabs.size === 1) {
                return;
            }

            tab.editor.dispose();
            tab.element.remove();
            tab.hostElement.remove();
            tabs.delete(tabId);

            if (activeTabId === tabId) {
                const remainingIds = Array.from(tabs.keys());
                if (remainingIds.length > 0) {
                    switchToTab(remainingIds[remainingIds.length - 1]);
                }
            }
        }

        newTabBtn.addEventListener('click', createNewTab);

        // WICHTIG: Diese Funktionen werden von C# aufgerufen
        window.GetText = function() {
            if (activeTabId) {
                const tab = tabs.get(activeTabId);
                if (tab && tab.editor) {
                    return tab.editor.getValue();
                }
            }
            return '';
        };

        window.SetText = function(content) {
            if (activeTabId) {
                const tab = tabs.get(activeTabId);
                if (tab && tab.editor) {
                    tab.editor.setValue(content);
                }
            }
        };

        window.addEventListener('resize', () => {
            if (activeTabId) {
                const tab = tabs.get(activeTabId);
                if (tab) {
                    tab.editor.layout();
                }
            }
        });
    </script>
</body>
</html>
